# モジュール設計について

Terraformのモジュールを作成する際の考え方について記載します。  
モジュールとは一定の目的を持ったコードの集合体であり、一般的なプログラミング言語でも用いられる考え方です。  
モジュールとして作成することには主に以下のメリットが挙げられます。

- 再利用できる
    - 異なる環境やプロジェクトで再利用でき、コードの重複を防げる
- 保守性が向上する
    - 共通にしたい設定をモジュール1箇所で管理できる
- 可読性が向上し、整理がしやすくなる
    - ある目的をもったコードの集合体になるため、構成が明確になり、何のために何をしているのかがわかりやすくなる
    - 決まり切った設定はモジュール内で閉じ、任意でよいパラメーターのみを変数として外から与えられるようにすることで、設定の目的を理解しやすくできる

ただし、初期の学習コストが高くなるというデメリットもあります。  
たとえば、

- 本番環境ではVPCフローログをS3に出力し、2箇所のAZにサブネットを2個ずつ作成する
- 開発環境ではVPCフローログは出力せず、1箇所のAZにサブネットを1個だけ作成する

といった構成でコードを作成したい場合、モジュール化をしなければ単純に本番用と開発用で個別に個数分の定義を記載していくだけで完成します。  
しかし、モジュール化をする場合は変数でVPCフローログの出力有無を切り替えられるように制御したり、サブネットを作る個数を可変にできるようにしたりするなどの作り込みが必要になって複雑化してしまいます。

中長期的なマネジメントの観点から見れば、保守性や可読性が高くなるモジュールの考えで最初からコードを作成していくことが推奨されますが、過度な作り込みを行ってしまわないように注意が必要です。

## モジュールのベストプラクティスやアンチパターン

既存のプログラミングのベストプラクティスやアンチパターンなどの多くの考え方がそのまま役立ちます。以下に代表的なものをいくつか記載します。

1. 単一責任の原則
    - 1つのモジュールには1つの目的のみを持たせる
    - 例: ネットワークを作成するモジュールではVPCに関するもののみを作成する
2. DRYの法則
    - 同じ処理を何度も記述しない
    - 一部のパラメーターが異なるだけの同種のリソースはループで作成する
    - 例: 名前とCIDRが異なるだけのサブネットは、それらだけマップで定義してfor_eachで作成する
3. YAGNIの法則
    - 必要なもののみを実装する
    - 不必要な部分の変数化、過度な一般化をしない
4. 適切にファイルを分割する
5. ドキュメントを作成する
6. ルールのチェックやテストを自動化して一定の品質を維持する

両立の難しい考え方やTerraformには適していない考え方もあるため、適切なバランスで気を付けていくことが重要です。

## モジュールの分け方

モジュールをどのように分けて各モジュールでどのリソースを作るのかは、Terraformコード開発においてもっとも重要な設計になります。  
分け方に正解はありませんが、主に以下のような観点で分けることが考えられます。

- 機能
    - ある機能を持った仕組みを実現するために必要なリソースでまとめる
- ライフサイクル
    - デプロイや削除を同じタイミングで行うリソースでまとめる
- チームが担当する範囲
    - アカウントの管理用リソース、インフラ用リソース、アプリ用リソースなどでまとめる

基本的には機能でまとめることを考えて、保守や運用を考えた際に不都合があれば適宜分け方を考え直していくとよいです。

## ディレクトリ構成

Terraformにはとくに定められたディレクトリ構成のベストプラクティスはなく、規模の大きさ、モジュール化のしやすさ、管理のしやすさ、可読性など、さまざまな要素を考慮して自分たちに都合のよい構成を選ぶ必要があります。  
今回は実行対象のAWS環境が複数あり、いずれの環境にも同じような構成のリソースを作成することから、以下のようにトップレベルで「実行用ディレクトリ、モジュール用ディレクトリ」に分け、さらにそれらのディレクトリ内で適宜ディレクトリを作成して細かく分けていく構成としています。  
また、各モジュール内では「`variables.tf`, `outputs.tf`, `versions.tf`」の3ファイルは作成を必須とし、それぞれモジュールのインプット定義、アウトプット定義、バージョン定義を目的としています。  
なお、バージョン定義にはモジュールの動作確認を行ったバージョンを記載しておくという目的もありますが、このファイルを作成しておくと後述するCIでの自動化を行う際に都合が良いという理由もあります。

```text
/
├─ env/       # 環境ごとの設定
│  ├─ prod/
│  │  └─ network/
│  │      ├─ main.tf
│  │      ├─ versions.tf
│  │      └─ provider.tf
│  │
│  ├─ staging/
│  └─ develop/
│
└─ modules/   # 機能単位のモジュール
   ├─ network/
   │  ├─ main.tf  # 複雑になる場合は適宜ファイルを分割する
   │  ├─ variables.tf
   │  ├─ outputs.tf
   │  └─ versions.tf
   │
   └─ user/
```
