# 本番アカウントへの実行方式

とくに制限がなければ[開発環境](./開発環境.md)に記載した内容を参考にして好きな方法を使えばよいですが、本番アカウントへの実行を行う場合はどのように実行するかを考えておく必要があります。  
ここではどのようなパターンが考えられ、それぞれどのような特徴があるのかを記載します。  
なお、ここでは実行対象がAWSアカウントの場合のみを想定して記載しています。

1. 外部端末からアクセスキーを使って実行
2. 実行対象のアカウントに実行用インスタンスを作成して実行
    - 2-1. 外部からSSHで接続するパターン
    - 2-2. マネジメントコンソールからセッションマネージャーで接続する
    - 2-3. 外部からセッションマネージャー経由のSSHで接続する
3. 実行対象のアカウントのCloudShellから実行
4. 別のアカウントにAssumeRoleの権限を付けたインスタンスを作成してクロスアカウントで実行

![](./image/実行パターン.drawio.svg)

## 1. 外部端末からアクセスキーを使って実行

アクセスキー作成以外にとくにAWSへリソース作成や設定変更等を行う必要がない一般的な方法になります。  
自由に実行環境を作ってどこからでも実行が可能なため、最初の構築段階でのみ使うのであれば問題ないと思いますが、今後の運用でも使っていく場合は別の方法にした方がよいです。

## 2. 実行対象のアカウントに実行用インスタンスを作成して実行

アカウント内部からの実行であれば権限の問題がシンプルになります。  
また、インスタンス周りのリソースをTerraformで作成するようにコードを作成しておくことで、統一された開発環境を容易に迅速に作成することもできます。  
インスタンスへどのように接続するかが問題になりますが、大まかには以下の3パターンがあります。  
結論から書くと、「外部からセッションマネージャー経由のSSHで接続するパターン」がもっとも推奨される接続方法になります。

- 外部からSSHで接続する
- マネジメントコンソールからセッションマネージャーで接続する
- 外部からセッションマネージャー経由のSSHで接続する

それぞれのパターンには以下のような違いがあります。

|     | 外部からSSH | コンソールからセッションマネージャー接続 | 外部からセッションマネージャー接続 |
| --- | --- | --- | --- |
| SSHキーの管理 | 要 | 不要 | 要 |
| SSHポート開放 | 要 | 不要 | 不要 |
| 外部への通信可否 | 不要 | 要 | 要 |
| パブリックIPの要否 | 要 | 不要 | 不要 |
| アクセスのログ記録 | ✕ | ◯ | ◯ |
| ファイル送受信 | ◯ | ✕ | ◯ |
| IAMでのアクセス制御 | ✕ | ◯ | ◯ |

![](./image/実行方式2.drawio.svg)

なお、上図ではインスタンスをパブリックサブネットに配置する構成にしていますが、可能であればインターネットへアクセスできるプライベートサブネットに配置する構成を推奨します。  
ただし、パブリックサブネットに配置する構成にする場合はセキュリティグループで不用意なインバウンド設定を行わないように注意してください。

### 2-1. 外部からSSHで接続するパターン

シンプルにパブリックサブネットにEC2インスタンスを配置して外部からパブリックIPへSSHで接続する方法です。  
プライベートサブネットに配置して前段に踏み台用のインスタンスを作成し、多段でSSH接続するといった構成も考えられます。  
踏み台を経由する構成の場合は実行用インスタンスにはパブリックIPが不要になりますが、結局踏み台にはパブリックIPが必要になります。  
もっとも古典的な方法ですが、現在はセッションマネージャーを使用する方法に勝るメリットがほぼないため、とくに理由がない限りは推奨されません。

### 2-2. マネジメントコンソールからセッションマネージャーで接続する

マネジメントコンソールから「接続」ボタンを押して接続します。  
大きな特徴として、セキュリティグループ等でインバウンドの通信許可を行わなければならない設定が1つもいらないという特徴があります。  
ただし、インスタンスにSSMエージェントがインストールされていること（標準のAMIであればデフォルトでインストールされている）と、セッションマネージャー用のAPIへの通信が行えることが条件になります。  
セッションマネージャー用のAPIが仲介して対象へ接続されるため、接続元の端末と接続先のインスタンスはそれぞれ互いにAPIへの通信さえ行えれば接続できることになります。  
NAT GatewayやVPCエンドポイントを使ってAPIへの通信を行えるようにしたプライベートサブネットに配置するのがもっともセキュアな構成になりますが、パブリックIPを付けずにパブリックサブネットに配置するだけの構成でも十分セキュアになります。  
AWSのAPIを使用して接続することから、IAMポリシーでユーザーやロールごとに接続可否の制御を行うこともできます。

なお、AWS CLIとSession Managerプラグインをインストールしている環境からであれば、以下のようなコマンドを実行することでターミナルからCLIでセッションマネージャーによる接続を行うこともできます。  
注意点として、SSHによる接続ではないため、SCPでファイルを送受信する等の機能は使えません。

```bash
aws ssm start-session --target EC2のID
```

### 2-3. 外部からセッションマネージャー経由のSSHで接続する

セッションマネージャー接続の発展型として、セッションマネージャーでSSHのセッションを作成してSSHで接続するといった方法になります。  
セッションマネージャーを使った接続はブラウザでマネジメントコンソールから行うかターミナル上からAWS CLIで行うかのどちらかであり、セキュアな構成にはできるものの、いろいろと制限のある使い方しかできないというデメリットがあります。  
一方で、SSHによる接続ではファイルの送受信が行えたり、VSCode等から繋いで直接ファイルを書き換えるといった汎用性の高い使い方ができるメリットがあります。  
そこで、セッションマネージャーで作成したセッションを使ってSSH接続することで両方のメリットのみを享受できるのがこの方法になります。   
以下のような手順でこの方法での接続が可能になります。

1. AWS CLIでセッションマネージャー接続できることを確認する

これで接続できない場合は、権限やCLIの設定に問題がある可能性があります。確実に接続できるとわかっている場合は確認不要です。

```bash
aws ssm start-session --target EC2のID
```

2. SSH Configに以下のような設定を記載する

接続元のSSH Configに接続先のインスタンスの情報とProxyCommandを記載します。  
これにより、セッションマネージャーでSSHセッションを作成してSSH接続するといった接続が可能になります。

```text
Host 接続先を示す好きな名前
    HostName インスタンスID
    IdentityFile インスタンスに設定したSSHキーのパス
    User 接続先のユーザ名
    ProxyCommand aws ssm start-session --target %h --document-name AWS-StartSSHSession
```

記載例

```text
Host terraform-dev
    HostName i-0abc123def456abcd0
    IdentityFile ~/.ssh/my-key.pem
    User ec2-user
    ProxyCommand aws ssm start-session --target %h --document-name AWS-StartSSHSession
```

3. SSHで接続する

SSHコマンドで接続します。上記の記載例の場合は`terraform-dev`を指定します。

```bash
ssh terraform-dev
```

権限や記載した情報に問題がなければ、これで対象へ接続できます。  
VSCodeを利用している場合はRemoteを使って接続できるようにもなっており、直接VSCodeでファイル操作やコマンド操作を行えるようになっています。

## 3. 実行対象のアカウントのCloudShellから実行

上記の「セッションマネージャーで接続したインスタンスからTerraform実行する」をより簡易的にしたような実行方法になります。  
CloudShellはAWSのマネジメントコンソールから利用できる標準サービスであり、特別にリソースを作成する必要はありません。  
また、CloudShellはサインインしているIAMユーザの権限で実行されるため、IAMユーザに十分な権限が与えられていれば、CloudShellから通常通りにTerraformを実行するだけで実行を行えます。  
ただし、CloudShellにはファイルを送れないことや、利用可能なストレージが極めて小さいこと、ホームディレクトリ以外のファイルは頻繁にリセットされることといった不便な制約がいくつかあります。  
リポジトリからコードをCloneしてそのままTerraformを実行するだけのシンプルな環境として使うのであれば問題ありませんが、開発環境として使うのは推奨できません。

## 4. 別のアカウントにAssumeRoleの権限を付けたインスタンスを作成してクロスアカウントで実行

実行対象のアカウントにはIAMロール以外のリソースを作成せず、AssumeRoleの機能を使ってクロスアカウントで実行する方法になります。  
実行対象のアカウントのIAMロールの設定を変更するだけで実行認可を制御できるため、普段の開発環境をそのまま使い回すことや複数のアカウントへ実行することもできます。  
ただし、しっかりとした運用を行わないと実行対象を間違えたり許可していない操作を行えてしまったり、トラブルが生じる可能性があることに注意してください。  
手順としては以下のようになります。

1. 実行対象のアカウントでAssumeRoleされるIAMロール（実際にTerraformを実行するロール）を作成する
2. IAMロールの信頼関係に実行元のアカウントにあるインスタンスプロファイルのIAMロールを追加する
3. 実行元のアカウントにあるインスタンスプロファイルのIAMロールに対象のIAMロールへAssumeRoleの操作を実行可能にする権限を追加する
